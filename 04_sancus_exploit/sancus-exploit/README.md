# Running a controlled `call` corruption on Sancus

Run the evaluation with `./run-sancus-eval.sh`.
This will produce two simulation outputs, the first one runs on the unchanged Sancus core, which will result in a memory violation (stopping the attack).
The second one runs after disabling the PC buffering, showing a successful overwrite of enclave values.

## Sample output

```
+ cd ../sancus-core
+ mkdir -p build
+ cd build/
+ cmake ..
CMake Deprecation Warning at CMakeLists.txt:3 (cmake_minimum_required):
  Compatibility with CMake < 2.8.12 will be removed from a future version of
  CMake.

  Update the VERSION argument <min> value or use a ...<max> suffix to tell
  CMake that the project does not need compatibility with older versions.


-- Configuring done
-- Generating done
-- Build files have been written to: /home/usec24/ipe-exposure/04_sancus_exploit/sancus-core/build
+ cd ..
+ ./core/sim/rtl_sim/run/run ../../../../../sancus-exploit/call_exploit
Cleanup...
 =======================================================
| Start simulation:             ../../../../../sancus-exploit/call_exploit
 =======================================================

 Seed:    271506116

Compile, link & generate IHEX file (Program Memory: 41984 B, Data Memory: 16384 B, Peripheral Space: 512 B)...

$ msp430-as      -I ../src/sancus -alsm pmem.s43 -o pmem.o > pmem.l43
$ msp430-objdump -xdsStr pmem.o >> pmem.l43
$ msp430-ld      -T ./pmem.x pmem.o -o pmem.elf
$ msp430-objcopy -O ihex pmem.elf pmem.ihex

Convert IHEX file to Verilog MEMH format...
Start Verilog simulation...
=== Spongent parameters ===
Rate:        18
State size: 176
===========================
=== SpongeWrap parameters ===
Rate:           16
Security:       64
Blocks in key:   4
=============================
=== File I/O ===
================
===============================================
                 START SIMULATION             |
===============================================
VCD info: dumpfile tb_openMSP430.vcd opened for output.
waiting for foo entry..
New SM 1 config: 5c34 5c36 0262 0268, 0
Vendor key: e3077c6a4e4c0cd9
SM key: b4b6e25fc02191e5
[SM 1] mem violation @0x0262 from 0x5c30
 ===============================================
|               SIMULATION FAILED               |
|     (the verilog stimulus didn't complete)    |
 ===============================================
DMA REPORT: Total Accesses: 1212        Total RD: 420         Total WR: 792        
            Total Errors:   0           Error RD: 0           Error WR: 0          

SIMULATION SEED:   271506116

+ git apply ../sancus-exploit/make-vulnerable.patch
+ ./core/sim/rtl_sim/run/run ../../../../../sancus-exploit/call_exploit
Cleanup...
 =======================================================
| Start simulation:             ../../../../../sancus-exploit/call_exploit
 =======================================================

 Seed:   -124293880

Compile, link & generate IHEX file (Program Memory: 41984 B, Data Memory: 16384 B, Peripheral Space: 512 B)...

$ msp430-as      -I ../src/sancus -alsm pmem.s43 -o pmem.o > pmem.l43
$ msp430-objdump -xdsStr pmem.o >> pmem.l43
$ msp430-ld      -T ./pmem.x pmem.o -o pmem.elf
$ msp430-objcopy -O ihex pmem.elf pmem.ihex

Convert IHEX file to Verilog MEMH format...
Start Verilog simulation...
=== Spongent parameters ===
Rate:        18
State size: 176
===========================
=== SpongeWrap parameters ===
Rate:           16
Security:       64
Blocks in key:   4
=============================
=== File I/O ===
================
===============================================
                 START SIMULATION             |
===============================================
VCD info: dumpfile tb_openMSP430.vcd opened for output.
waiting for foo entry..
New SM 1 config: 5c34 5c36 0262 0268, 0
Vendor key: e3077c6a4e4c0cd9
SM key: b4b6e25fc02191e5
ERROR:        ====== attacker successfully changed protected value ======              1051750
 ===============================================
|               SIMULATION FAILED               |
|     (some verilog stimulus checks failed)     |
 ===============================================
DMA REPORT: Total Accesses: 1185        Total RD: 398         Total WR: 787        
            Total Errors:   0           Error RD: 0           Error WR: 0          

SIMULATION SEED:  -124293880

+ git checkout .
Updated 4 paths from the index
```
